name: ðŸ“Š è¨˜äº‹çµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆ

on:
  schedule:
    # æ¯Žé€±æ—¥æ›œæ—¥ã®åˆå‰9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  generate-analytics:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: ðŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ðŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install -r requirements.txt
          pip install matplotlib pandas
      
      - name: ðŸ“Š çµ±è¨ˆæƒ…å ±ç”Ÿæˆ
        run: |
          cat > scripts/generate_analytics.py << 'EOF'
          import json
          import matplotlib.pyplot as plt
          import pandas as pd
          from pathlib import Path
          from datetime import datetime
          from collections import defaultdict
          from utils.markdown_parser import MarkdownParser
          
          def analyze_articles():
              parser = MarkdownParser()
              
              # è¨˜äº‹ãƒ‡ãƒ¼ã‚¿åŽé›†
              articles_data = []
              
              # draftsãƒ•ã‚©ãƒ«ãƒ€
              for file in Path('articles/drafts').rglob('*.md'):
                  data = parser.parse_file(file)
                  articles_data.append({
                      'file': str(file),
                      'status': 'draft',
                      'metadata': data['metadata'],
                      'content_length': len(data['content']),
                      'created': data['metadata'].get('param_created', '')
                  })
              
              # publishedãƒ•ã‚©ãƒ«ãƒ€
              for file in Path('articles/published').rglob('*.md'):
                  data = parser.parse_file(file)
                  articles_data.append({
                      'file': str(file),
                      'status': 'published',
                      'metadata': data['metadata'],
                      'content_length': len(data['content']),
                      'created': data['metadata'].get('param_created', '')
                  })
              
              # çµ±è¨ˆè¨ˆç®—
              stats = {
                  'total_articles': len(articles_data),
                  'draft_count': len([a for a in articles_data if a['status'] == 'draft']),
                  'published_count': len([a for a in articles_data if a['status'] == 'published']),
                  'total_characters': sum(a['content_length'] for a in articles_data),
                  'avg_content_length': sum(a['content_length'] for a in articles_data) / len(articles_data) if articles_data else 0,
                  'categories': defaultdict(int),
                  'tags': defaultdict(int),
                  'articles_by_month': defaultdict(int)
              }
              
              # ã‚«ãƒ†ã‚´ãƒªãƒ»ã‚¿ã‚°é›†è¨ˆ
              for article in articles_data:
                  if 'param_category' in article['metadata']:
                      categories = article['metadata']['param_category'].split(',')
                      for cat in categories:
                          stats['categories'][cat.strip()] += 1
                  
                  if 'param_tags' in article['metadata']:
                      tags = article['metadata']['param_tags'].split(',')
                      for tag in tags:
                          stats['tags'][tag.strip()] += 1
                  
                  # æœˆåˆ¥é›†è¨ˆ
                  if article['created']:
                      try:
                          date = datetime.fromisoformat(article['created'][:10])
                          month_key = date.strftime('%Y-%m')
                          stats['articles_by_month'][month_key] += 1
                      except:
                          pass
              
              return stats, articles_data
          
          def create_visualizations(stats):
              # 1. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥è¨˜äº‹æ•°
              plt.figure(figsize=(10, 6))
              plt.subplot(2, 2, 1)
              statuses = ['ä¸‹æ›¸ã', 'å…¬é–‹æ¸ˆã¿']
              counts = [stats['draft_count'], stats['published_count']]
              plt.pie(counts, labels=statuses, autopct='%1.1f%%')
              plt.title('è¨˜äº‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ†å¸ƒ')
              
              # 2. ã‚«ãƒ†ã‚´ãƒªåˆ¥è¨˜äº‹æ•°
              plt.subplot(2, 2, 2)
              if stats['categories']:
                  categories = dict(sorted(stats['categories'].items(), key=lambda x: x[1], reverse=True)[:10])
                  plt.bar(categories.keys(), categories.values())
                  plt.xticks(rotation=45, ha='right')
                  plt.title('ã‚«ãƒ†ã‚´ãƒªåˆ¥è¨˜äº‹æ•°ï¼ˆä¸Šä½10ï¼‰')
              
              # 3. æœˆåˆ¥æŠ•ç¨¿æ•°
              plt.subplot(2, 2, 3)
              if stats['articles_by_month']:
                  months = sorted(stats['articles_by_month'].items())
                  plt.plot([m[0] for m in months], [m[1] for m in months], marker='o')
                  plt.xticks(rotation=45, ha='right')
                  plt.title('æœˆåˆ¥æŠ•ç¨¿æ•°æŽ¨ç§»')
              
              # 4. ã‚¿ã‚°ã‚¯ãƒ©ã‚¦ãƒ‰é¢¨ï¼ˆä¸Šä½20ã‚¿ã‚°ï¼‰
              plt.subplot(2, 2, 4)
              if stats['tags']:
                  tags = dict(sorted(stats['tags'].items(), key=lambda x: x[1], reverse=True)[:20])
                  plt.barh(list(tags.keys()), list(tags.values()))
                  plt.title('äººæ°—ã‚¿ã‚°ï¼ˆä¸Šä½20ï¼‰')
              
              plt.tight_layout()
              plt.savefig('analytics_report.png', dpi=150, bbox_inches='tight')
              plt.close()
          
          if __name__ == "__main__":
              stats, articles = analyze_articles()
              
              # ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
              report = {
                  'generated_at': datetime.now().isoformat(),
                  'statistics': {
                      'ç·è¨˜äº‹æ•°': stats['total_articles'],
                      'ä¸‹æ›¸ã': stats['draft_count'],
                      'å…¬é–‹æ¸ˆã¿': stats['published_count'],
                      'ç·æ–‡å­—æ•°': f"{stats['total_characters']:,}",
                      'å¹³å‡æ–‡å­—æ•°': f"{stats['avg_content_length']:.0f}",
                      'ã‚«ãƒ†ã‚´ãƒªæ•°': len(stats['categories']),
                      'ã‚¿ã‚°æ•°': len(stats['tags'])
                  },
                  'top_categories': dict(sorted(stats['categories'].items(), key=lambda x: x[1], reverse=True)[:5]),
                  'top_tags': dict(sorted(stats['tags'].items(), key=lambda x: x[1], reverse=True)[:10])
              }
              
              # JSONä¿å­˜
              with open('analytics_report.json', 'w', encoding='utf-8') as f:
                  json.dump(report, f, ensure_ascii=False, indent=2)
              
              # ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ
              create_visualizations(stats)
              
              print("ðŸ“Š çµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†")
          EOF
          
          python scripts/generate_analytics.py
      
      - name: ðŸ“¤ ãƒ¬ãƒãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: analytics-report
          path: |
            analytics_report.json
            analytics_report.png
          retention-days: 30
          compression-level: 9
      
      - name: ðŸ“Š ã‚µãƒžãƒªãƒ¼è¡¨ç¤º
        run: |
          echo "## ðŸ“Š è¨˜äº‹çµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f analytics_report.json ]; then
            cat analytics_report.json | jq -r '
              "### ðŸ“ˆ åŸºæœ¬çµ±è¨ˆ\n" +
              (.statistics | to_entries | map("- **" + .key + ":** " + (.value | tostring)) | join("\n")) +
              "\n\n### ðŸ·ï¸ äººæ°—ã‚«ãƒ†ã‚´ãƒª TOP5\n" +
              (.top_categories | to_entries | map(((.key | tostring) + 1) | tostring + ". " + .value.key + " (" + (.value.value | tostring) + "è¨˜äº‹)") | join("\n")) +
              "\n\n### ðŸ”– äººæ°—ã‚¿ã‚° TOP10\n" +
              (.top_tags | to_entries | map(((.key | tostring) + 1) | tostring + ". " + .value.key + " (" + (.value.value | tostring) + "è¨˜äº‹)") | join("\n"))
            ' >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“Š è©³ç´°ãªã‚°ãƒ©ãƒ•ã¯[Artifactsã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})ã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
          fi