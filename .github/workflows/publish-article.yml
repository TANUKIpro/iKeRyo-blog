name: ğŸ“ è¨˜äº‹å…¬é–‹ã‚·ã‚¹ãƒ†ãƒ 

on:
  pull_request:
    paths:
      - 'articles/drafts/**'
      - 'articles/published/**'
    types: [opened, synchronize, closed]

env:
  WP_URL: ${{ secrets.WP_URL }}
  WP_USERNAME: ${{ secrets.WP_USERNAME }}
  WP_APP_PASSWORD: ${{ secrets.WP_APP_PASSWORD }}

jobs:
  # PRæ™‚: ä¸‹æ›¸ãã¨ã—ã¦æŠ•ç¨¿
  draft-publish:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: ğŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install -r requirements.txt
      
      - name: ğŸ” å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ¤œå‡º
        id: changed-files
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E '\.md$' | head -10)
          echo "Changed files: $CHANGED_FILES"
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: ğŸ“ è¨˜äº‹å‡¦ç†ï¼ˆä¸‹æ›¸ãï¼‰
        if: steps.changed-files.outputs.files != ''
        run: |
          echo "${{ steps.changed-files.outputs.files }}" | while read -r file; do
            if [ -n "$file" ] && [ -f "$file" ]; then
              echo "ğŸ”„ å‡¦ç†ä¸­: $file"
              python scripts/process_article.py "$file"
              
              if [ -f output.json ]; then
                echo "## ğŸ“ $(basename "$file")" >> $GITHUB_STEP_SUMMARY
                echo "**WordPress URL:** $(cat output.json | jq -r '.wordpress_url // "ã‚¨ãƒ©ãƒ¼"')" >> $GITHUB_STEP_SUMMARY
                echo "**å‡¦ç†ç”»åƒæ•°:** $(cat output.json | jq '.images_processed // 0')" >> $GITHUB_STEP_SUMMARY
                echo "**å‡¦ç†æ™‚é–“:** $(cat output.json | jq -r '.processing_time_seconds // 0')ç§’" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

  # PRãƒãƒ¼ã‚¸æ™‚: å…¬é–‹çŠ¶æ…‹ã«å¤‰æ›´
  production-publish:
    if: github.event.action == 'closed' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: ğŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install -r requirements.txt
      
      - name: ğŸ” ãƒãƒ¼ã‚¸å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«æ¤œå‡º
        id: merged-files
        run: |
          MERGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E '\.md$')
          echo "Merged files: $MERGED_FILES"
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$MERGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: ğŸš€ è¨˜äº‹å…¬é–‹
        if: steps.merged-files.outputs.files != ''
        run: |
          echo "${{ steps.merged-files.outputs.files }}" | while read -r file; do
            if [ -n "$file" ] && [ -f "$file" ]; then
              echo "ğŸš€ å…¬é–‹å‡¦ç†: $file"
              python scripts/process_article.py "$file" --publish
            fi
          done
      
      - name: ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ç§»å‹•ï¼ˆdrafts â†’ publishedï¼‰
        if: steps.merged-files.outputs.files != ''
        run: |
          MOVED_FILES=""
          echo "${{ steps.merged-files.outputs.files }}" | while read -r file; do
            if [[ $file == articles/drafts/* ]]; then
              TARGET="articles/published/$(basename "$file")"
              if [ -f "$file" ]; then
                git mv "$file" "$TARGET"
                echo "ğŸ“ ç§»å‹•: $file â†’ $TARGET"
                MOVED_FILES="$MOVED_FILES $file"
              fi
            fi
          done
          
          if [ -n "$(git status --porcelain)" ]; then
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add .
            git commit -m "ğŸ“ è¨˜äº‹å…¬é–‹ï¼šdrafts â†’ published"
            git push
          fi

  # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆæ¯æ—¥å®Ÿè¡Œï¼‰
  health-check:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: ğŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install -r requirements.txt
      
      - name: ğŸ¥ WordPressæ¥ç¶šãƒ†ã‚¹ãƒˆ
        run: |
          python -c "
          from scripts.wordpress_api import WordPressAPI
          import os
          
          api = WordPressAPI(
              os.getenv('WP_URL'),
              os.getenv('WP_USERNAME'), 
              os.getenv('WP_APP_PASSWORD')
          )
          
          if api.test_connection():
              print('âœ… WordPress APIæ¥ç¶šæ­£å¸¸')
          else:
              print('âŒ WordPress APIæ¥ç¶šå¤±æ•—')
              exit(1)
          "