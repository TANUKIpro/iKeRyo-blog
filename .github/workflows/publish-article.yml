name: ðŸ“ è¨˜äº‹å…¬é–‹ã‚·ã‚¹ãƒ†ãƒ 

on:
  pull_request:
    paths:
      - 'articles/drafts/**/*.md'
      - 'articles/published/**/*.md'
    types: [opened, synchronize, closed]

env:
  WP_URL: ${{ secrets.WP_URL }}
  WP_USERNAME: ${{ secrets.WP_USERNAME }}
  WP_APP_PASSWORD: ${{ secrets.WP_APP_PASSWORD }}

jobs:
  # PRæ™‚: ä¸‹æ›¸ãã¨ã—ã¦æŠ•ç¨¿
  draft-publish:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆã‚ˆã‚Šæ­£ç¢ºãªå·®åˆ†æ¤œå‡ºã®ãŸã‚ï¼‰
      
      - name: ðŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ðŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install -r requirements.txt
      
      - name: ðŸ” å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ¤œå‡º
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files: |
            articles/drafts/**/*.md
            articles/published/**/*.md
          separator: "\n"
      
      - name: ðŸ“ è¨˜äº‹å‡¦ç†ï¼ˆä¸‹æ›¸ãï¼‰
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "## ðŸ“ WordPressä¸‹æ›¸ãæŠ•ç¨¿çµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          SUCCESS_COUNT=0
          FAIL_COUNT=0
          
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            if [ -f "$file" ]; then
              echo "ðŸ”„ å‡¦ç†ä¸­: $file"
              
              if python scripts/process_article.py "$file"; then
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                
                if [ -f output.json ]; then
                  WP_URL=$(cat output.json | jq -r '.wordpress_url // "ã‚¨ãƒ©ãƒ¼"')
                  IMAGES=$(cat output.json | jq '.images_processed // 0')
                  TIME=$(cat output.json | jq -r '.processing_time_seconds // 0')
                  UPDATED=$(cat output.json | jq -r '.updated // false')
                  
                  ACTION="ä½œæˆ"
                  if [ "$UPDATED" = "true" ]; then
                    ACTION="æ›´æ–°"
                  fi
                  
                  echo "### âœ… $(basename "$file")" >> $GITHUB_STEP_SUMMARY
                  echo "- **ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:** $ACTION" >> $GITHUB_STEP_SUMMARY
                  echo "- **WordPress URL:** $WP_URL" >> $GITHUB_STEP_SUMMARY
                  echo "- **å‡¦ç†ç”»åƒæ•°:** $IMAGES" >> $GITHUB_STEP_SUMMARY
                  echo "- **å‡¦ç†æ™‚é–“:** ${TIME}ç§’" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                fi
              else
                FAIL_COUNT=$((FAIL_COUNT + 1))
                echo "### âŒ $(basename "$file")" >> $GITHUB_STEP_SUMMARY
                echo "- **ã‚¨ãƒ©ãƒ¼:** å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**æˆåŠŸ:** $SUCCESS_COUNT | **å¤±æ•—:** $FAIL_COUNT" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ’¬ PRã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## ðŸ“ WordPressä¸‹æ›¸ãæŠ•ç¨¿çµæžœ\n\n';
            
            if (fs.existsSync('output.json')) {
              const output = JSON.parse(fs.readFileSync('output.json', 'utf8'));
              comment += `âœ… **${output.wordpress_url}** ã«ä¸‹æ›¸ãã¨ã—ã¦æŠ•ç¨¿ã•ã‚Œã¾ã—ãŸã€‚\n\n`;
              comment += `- å‡¦ç†ç”»åƒæ•°: ${output.images_processed}\n`;
              comment += `- å‡¦ç†æ™‚é–“: ${output.processing_time_seconds}ç§’\n`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # PRãƒžãƒ¼ã‚¸æ™‚: å…¬é–‹çŠ¶æ…‹ã«å¤‰æ›´
  production-publish:
    if: github.event.action == 'closed' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ðŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ðŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install -r requirements.txt
      
      - name: ðŸ” ãƒžãƒ¼ã‚¸å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«æ¤œå‡º
        id: merged-files
        uses: tj-actions/changed-files@v40
        with:
          files: |
            articles/drafts/**/*.md
          separator: "\n"
      
      - name: ðŸš€ è¨˜äº‹å…¬é–‹ã¨ãƒ•ã‚¡ã‚¤ãƒ«ç§»å‹•
        if: steps.merged-files.outputs.any_changed == 'true'
        run: |
          echo "## ðŸš€ è¨˜äº‹å…¬é–‹çµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Gitè¨­å®š
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          PUBLISHED_COUNT=0
          MOVED_FILES=""
          
          for file in ${{ steps.merged-files.outputs.all_changed_files }}; do
            if [ -f "$file" ] && [[ $file == articles/drafts/* ]]; then
              echo "ðŸš€ å…¬é–‹å‡¦ç†: $file"
              
              # WordPressã«å…¬é–‹
              if python scripts/process_article.py "$file" --publish; then
                PUBLISHED_COUNT=$((PUBLISHED_COUNT + 1))
                
                # ãƒ•ã‚¡ã‚¤ãƒ«ç§»å‹•
                FILENAME=$(basename "$file")
                TARGET_DIR="articles/published/$(date +%Y/%m)"
                TARGET_PATH="$TARGET_DIR/$FILENAME"
                
                # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
                mkdir -p "$TARGET_DIR"
                
                # ãƒ•ã‚¡ã‚¤ãƒ«ç§»å‹•
                git mv "$file" "$TARGET_PATH"
                MOVED_FILES="$MOVED_FILES\n- $file â†’ $TARGET_PATH"
                
                if [ -f output.json ]; then
                  WP_URL=$(cat output.json | jq -r '.wordpress_url // "ã‚¨ãƒ©ãƒ¼"')
                  echo "### âœ… $FILENAME" >> $GITHUB_STEP_SUMMARY
                  echo "- **WordPress URL:** $WP_URL" >> $GITHUB_STEP_SUMMARY
                  echo "- **ç§»å‹•å…ˆ:** $TARGET_PATH" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                fi
              fi
            fi
          done
          
          # å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "ðŸ“ è¨˜äº‹å…¬é–‹å®Œäº†: $PUBLISHED_COUNT ä»¶ã®è¨˜äº‹ã‚’ published ã¸ç§»å‹•"
            git push
            
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "**å…¬é–‹è¨˜äº‹æ•°:** $PUBLISHED_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "**ç§»å‹•ãƒ•ã‚¡ã‚¤ãƒ«:**" >> $GITHUB_STEP_SUMMARY
            echo -e "$MOVED_FILES" >> $GITHUB_STEP_SUMMARY
          fi