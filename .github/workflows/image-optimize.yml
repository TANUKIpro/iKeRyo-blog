name: ğŸ–¼ï¸ ç”»åƒæœ€é©åŒ–

on:
  push:
    paths:
      - 'assets/images/**'
      - 'articles/**/*.png'
      - 'articles/**/*.jpg'
      - 'articles/**/*.jpeg'
      - 'articles/**/*.gif'
      - 'articles/**/*.webp'

jobs:
  optimize-images:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 2
      
      - name: ğŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install Pillow requests pyyaml
      
      - name: ğŸ” å¤‰æ›´ç”»åƒæ¤œå‡º
        id: changed-images
        uses: tj-actions/changed-files@v40
        with:
          files: |
            **/*.jpg
            **/*.jpeg
            **/*.png
            **/*.gif
            **/*.webp
          separator: " "
      
      - name: ğŸ–¼ï¸ ç”»åƒæœ€é©åŒ–å®Ÿè¡Œ
        if: steps.changed-images.outputs.any_changed == 'true'
        run: |
          cat > scripts/batch_image_optimizer.py << 'EOF'
          import sys
          import json
          from pathlib import Path
          sys.path.append(str(Path(__file__).parent))
          
          from utils.obsidian_processor import ImageOptimizer
          
          def optimize_images(image_files):
              optimizer = ImageOptimizer("temp")
              results = []
              
              for image_file in image_files:
                  if not Path(image_file).exists():
                      continue
                      
                  try:
                      print(f"ğŸ”„ æœ€é©åŒ–ä¸­: {image_file}")
                      result = optimizer.optimize(image_file)
                      
                      # å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æœ€é©åŒ–ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã§ç½®ãæ›ãˆ
                      if not result.get('is_gif') and 'error' not in result:
                          optimized_path = Path(result['optimized_path'])
                          original_path = Path(result['original_path'])
                          
                          # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
                          backup_path = original_path.with_suffix('.backup' + original_path.suffix)
                          original_path.rename(backup_path)
                          
                          # æœ€é©åŒ–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…ƒã®å ´æ‰€ã«ç§»å‹•
                          optimized_path.rename(original_path)
                          
                          # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å‰Šé™¤
                          backup_path.unlink()
                          
                          results.append({
                              'file': image_file,
                              'size_reduction': result['size_reduction'],
                              'status': 'optimized'
                          })
                      else:
                          results.append({
                              'file': image_file,
                              'size_reduction': 0,
                              'status': 'skipped' if result.get('is_gif') else 'error'
                          })
                          
                  except Exception as e:
                      print(f"âŒ ã‚¨ãƒ©ãƒ¼: {image_file} - {str(e)}")
                      results.append({
                          'file': image_file,
                          'error': str(e),
                          'status': 'error'
                      })
              
              # ãƒ¬ãƒãƒ¼ãƒˆä¿å­˜
              with open('optimization_report.json', 'w') as f:
                  json.dump(results, f, indent=2)
              
              return results
          
          if __name__ == "__main__":
              files = sys.argv[1:]
              results = optimize_images(files)
              
              # ã‚µãƒãƒªãƒ¼å‡ºåŠ›
              optimized = len([r for r in results if r['status'] == 'optimized'])
              skipped = len([r for r in results if r['status'] == 'skipped'])
              errors = len([r for r in results if r['status'] == 'error'])
              
              print(f"\nğŸ“Š æœ€é©åŒ–å®Œäº†: {optimized}ä»¶æˆåŠŸ, {skipped}ä»¶ã‚¹ã‚­ãƒƒãƒ—, {errors}ä»¶ã‚¨ãƒ©ãƒ¼")
          EOF
          
          python scripts/batch_image_optimizer.py ${{ steps.changed-images.outputs.all_changed_files }}
      
      - name: ğŸ“Š æœ€é©åŒ–çµæœãƒ¬ãƒãƒ¼ãƒˆ
        if: steps.changed-images.outputs.any_changed == 'true'
        run: |
          echo "## ğŸ–¼ï¸ ç”»åƒæœ€é©åŒ–çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f optimization_report.json ]; then
            cat optimization_report.json | jq -r '.[] | 
              if .status == "optimized" then
                "### âœ… " + .file + "\n- ã‚µã‚¤ã‚ºå‰Šæ¸›: " + (.size_reduction | tostring) + "%\n"
              elif .status == "skipped" then
                "### â­ï¸ " + .file + "\n- GIFãƒ•ã‚¡ã‚¤ãƒ«ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—\n"
              else
                "### âŒ " + .file + "\n- ã‚¨ãƒ©ãƒ¼: " + (.error // "ä¸æ˜"ï¼‰ + "\n"
              end' >> $GITHUB_STEP_SUMMARY
              
            TOTAL_REDUCTION=$(cat optimization_report.json | jq '[.[] | select(.status == "optimized") | .size_reduction] | add / length')
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "**å¹³å‡ã‚µã‚¤ã‚ºå‰Šæ¸›ç‡:** ${TOTAL_REDUCTION}%" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ğŸ’¾ å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
        if: steps.changed-images.outputs.any_changed == 'true'
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add .
            git commit -m "ğŸ–¼ï¸ ç”»åƒæœ€é©åŒ–å®Œäº†"
            git push
          fi