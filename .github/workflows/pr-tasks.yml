name: ğŸš€ ä¸‹æ›¸ãå‡¦ç†ã‚¿ã‚¹ã‚¯

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'articles/**/*.md'

env:
  WP_URL: ${{ secrets.WP_URL }}
  WP_USERNAME: ${{ secrets.WP_USERNAME }}
  WP_APP_PASSWORD: ${{ secrets.WP_APP_PASSWORD }}

jobs:
  draft-tasks:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install -r requirements.txt
          pip install pyspellchecker language-tool-python

      - name: ğŸ” ä¸‹æ›¸ããƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
        id: check-drafts
        run: |
          files=$(find articles/drafts -name '*.md' -print0 | tr '\0' '\n')
          echo "files<<EOF" >> "$GITHUB_OUTPUT"
          echo "$files" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          if [ -n "$files" ]; then
            echo "found=true" >> "$GITHUB_OUTPUT"
          else
            echo "found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: ğŸ“ è¨˜äº‹å‡¦ç†ï¼ˆä¸‹æ›¸ãï¼‰
        if: steps.check-drafts.outputs.found == 'true'
        run: |
          echo "## ğŸ“ WordPressä¸‹æ›¸ãæŠ•ç¨¿çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          SUCCESS_COUNT=0
          FAIL_COUNT=0
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              echo "ğŸ”„ å‡¦ç†ä¸­: $file"
              if python scripts/process_article.py "$file"; then
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                if [ -f output.json ]; then
                  WP_URL=$(cat output.json | jq -r '.wordpress_url // "ã‚¨ãƒ©ãƒ¼"')
                  IMAGES=$(cat output.json | jq '.images_processed // 0')
                  TIME=$(cat output.json | jq -r '.processing_time_seconds // 0')
                  UPDATED=$(cat output.json | jq -r '.updated // false')
                  ACTION="ä½œæˆ"
                  if [ "$UPDATED" = "true" ]; then
                    ACTION="æ›´æ–°"
                  fi
                  echo "### âœ… $(basename "$file")" >> $GITHUB_STEP_SUMMARY
                  echo "- **ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:** $ACTION" >> $GITHUB_STEP_SUMMARY
                  echo "- **WordPress URL:** $WP_URL" >> $GITHUB_STEP_SUMMARY
                  echo "- **å‡¦ç†ç”»åƒæ•°:** $IMAGES" >> $GITHUB_STEP_SUMMARY
                  echo "- **å‡¦ç†æ™‚é–“:** ${TIME}ç§’" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                fi
              else
                FAIL_COUNT=$((FAIL_COUNT + 1))
                echo "### âŒ $(basename "$file")" >> $GITHUB_STEP_SUMMARY
                echo "- **ã‚¨ãƒ©ãƒ¼:** å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done <<< "${{ steps.check-drafts.outputs.files }}"
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**æˆåŠŸ:** $SUCCESS_COUNT | **å¤±æ•—:** $FAIL_COUNT" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ’¬ PRã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
        if: steps.check-drafts.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const commentMarker = '<!-- draft-result -->';
            let comment = `${commentMarker}\n## ğŸ“ WordPressä¸‹æ›¸ãæŠ•ç¨¿çµæœ\n\n`;
            if (fs.existsSync('output.json')) {
              const output = JSON.parse(fs.readFileSync('output.json', 'utf8'));
              comment += `âœ… **${output.wordpress_url}** ã«ä¸‹æ›¸ãã¨ã—ã¦æŠ•ç¨¿ã•ã‚Œã¾ã—ãŸã€‚\n\n`;
              comment += `- å‡¦ç†ç”»åƒæ•°: ${output.images_processed}\n`;
              comment += `- å‡¦ç†æ™‚é–“: ${output.processing_time_seconds}ç§’\n`;
            }
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            const existing = comments.find(c => c.body.startsWith(commentMarker));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

      - name: ğŸ” å“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
        if: steps.check-drafts.outputs.found == 'true'
        run: |
          echo "${{ steps.check-drafts.outputs.files }}" | xargs -d '\n' python scripts/quality_checker.py

      - name: ğŸ“Š å“è³ªãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        if: steps.check-drafts.outputs.found == 'true'
        run: |
          echo "## âœ… è¨˜äº‹å“è³ªãƒã‚§ãƒƒã‚¯çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f quality_report.json ]; then
            cat quality_report.json | jq -r '.[] |
              "### ğŸ“„ " + (.file | split("/") | last) + "\n" +
              "#### ğŸ“Š çµ±è¨ˆæƒ…å ±\n" +
              "- æ–‡å­—æ•°: " + (.statistics.character_count | tostring) + "\n" +
              "- æ¨å®šèª­äº†æ™‚é–“: " + (.statistics.reading_time_minutes | tostring) + "åˆ†\n" +
              "- ç”»åƒæ•°: " + (.checks.images.image_count | tostring) + "\n" +
              "- å¤–éƒ¨ãƒªãƒ³ã‚¯: " + (.checks.links.external_links | tostring) + "\n\n" +
              "#### ğŸ” ãƒã‚§ãƒƒã‚¯çµæœ\n" +
              (if .checks.metadata.passed then "âœ… ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿: OK" else "âŒ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿: " + (.checks.metadata.issues | join(", ")) end) + "\n" +
              (if .checks.images.passed then "âœ… ç”»åƒ: OK" else "âŒ ç”»åƒ: " + (.checks.images.issues | join(", ")) end) + "\n" +
              (if .checks.format.passed then "âœ… ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: OK" else "âŒ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: " + (.checks.format.issues | join(", ")) end) + "\n"'
            >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ’¬ PRã‚³ãƒ¡ãƒ³ãƒˆã§çµæœå…±æœ‰
        if: steps.check-drafts.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (!fs.existsSync('quality_report.json')) return;
            const commentMarker = '<!-- quality-result -->';
            const report = JSON.parse(fs.readFileSync('quality_report.json', 'utf8'));
            let comment = `${commentMarker}\n## âœ… è¨˜äº‹å“è³ªãƒã‚§ãƒƒã‚¯çµæœ\n\n`;
            let hasIssues = false;
            for (const result of report) {
              const filename = result.file.split('/').pop();
              comment += `### ğŸ“„ ${filename}\n\n`;
              comment += `ğŸ“Š **çµ±è¨ˆ:** ${result.statistics.character_count}æ–‡å­— / èª­äº†${result.statistics.reading_time_minutes}åˆ†\n\n`;
              const allChecks = Object.values(result.checks);
              const failedChecks = allChecks.filter(check => !check.passed);
              if (failedChecks.length > 0) {
                hasIssues = true;
                comment += 'âš ï¸ **æ”¹å–„ãŒå¿…è¦ãªé …ç›®:**\n';
                for (const check of failedChecks) {
                  for (const issue of check.issues) {
                    comment += `- ${issue}\n`;
                  }
                }
              } else {
                comment += 'âœ… ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ã«åˆæ ¼ã—ã¾ã—ãŸï¼\n';
              }
              comment += '\n';
            }
            if (hasIssues) {
              comment += '> ğŸ’¡ ä¸Šè¨˜ã®é …ç›®ã‚’ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚';
            }
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            const existing = comments.find(c => c.body.startsWith(commentMarker));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

      - name: ğŸ“„ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆ
        if: steps.check-drafts.outputs.found == 'true'
        run: |
          mkdir -p previews
          cat > scripts/generate_preview.py <<'PY'
          import sys
          from pathlib import Path
          from utils.markdown_parser import MarkdownParser
          from utils.obsidian_processor import ObsidianProcessor

          def generate_preview(markdown_file):
              parser = MarkdownParser()
              processor = ObsidianProcessor('.')
              article_data = parser.parse_file(markdown_file)
              content = processor.process_obsidian_syntax(article_data['content'])
              html_content = parser.to_html(content)
              preview_html = f"""
          <!DOCTYPE html>
          <html lang="ja">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>{article_data['metadata'].get('title', Path(markdown_file).stem)}</title>
              <style>
                  body {{ max-width: 800px; margin: 0 auto; padding: 20px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; }}
                  img {{ max-width: 100%; height: auto; display: block; margin: 20px auto; }}
                  figure {{ text-align: center; margin: 20px 0; }}
                  figcaption {{ font-size: 0.9em; color: #666; margin-top: 10px; }}
                  pre {{ background: #f4f4f4; padding: 15px; overflow-x: auto; border-radius: 5px; }}
                  blockquote {{ border-left: 4px solid #ddd; margin-left: 0; padding-left: 20px; color: #666; }}
                  .metadata {{ background: #f9f9f9; padding: 15px; border-radius: 5px; margin-bottom: 30px; font-size: 0.9em; }}
                  .metadata strong {{ color: #333; }}
              </style>
          </head>
          <body>
              <div class="metadata">
                  <strong>ã‚«ãƒ†ã‚´ãƒª:</strong> {article_data['metadata'].get('param_category', 'ãªã—')}<br>
                  <strong>ã‚¿ã‚°:</strong> {article_data['metadata'].get('param_tags', 'ãªã—')}<br>
                  <strong>ä½œæˆæ—¥:</strong> {article_data['metadata'].get('param_created', 'æœªè¨­å®š')}
              </div>
              {html_content}
          </body>
          </html>
          """
              preview_path = Path('previews') / f"{Path(markdown_file).stem}.html"
              preview_path.write_text(preview_html, encoding='utf-8')
              return preview_path

          if __name__ == '__main__':
              markdown_file = sys.argv[1]
              preview_path = generate_preview(markdown_file)
              print(f"Preview generated: {preview_path}")
          PY
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              echo "ğŸ“„ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆ: $file"
              python scripts/generate_preview.py "$file"
            fi
          done <<< "${{ steps.check-drafts.outputs.files }}"

      - name: ğŸ“¤ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: steps.check-drafts.outputs.found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: article-previews
          path: previews/
          retention-days: 7
          compression-level: 9

      - name: ğŸ’¬ PRã‚³ãƒ¡ãƒ³ãƒˆã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒªãƒ³ã‚¯å…±æœ‰
        if: steps.check-drafts.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const artifactUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const commentMarker = '<!-- preview-link -->';
            const comment = `${commentMarker}\n## ğŸ‘€ è¨˜äº‹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼\n\n` +
              `ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼HTMLãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚\n\n` +
              `[ğŸ“„ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰](${artifactUrl})\n\n` +
              `> **Note:** Artifactsã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ \`article-previews\` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦ãã ã•ã„ã€‚`;
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            const existing = comments.find(c => c.body.startsWith(commentMarker));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
