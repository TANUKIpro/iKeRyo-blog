name: ğŸ’¾ è¨˜äº‹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

on:
  schedule:
    # æ¯é€±æœˆæ›œæ—¥ã®åˆå‰3æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 18 * * 0'
  workflow_dispatch:

jobs:
  backup-wordpress:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install -r requirements.txt
      
      - name: ğŸ’¾ WordPressã‹ã‚‰ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å–å¾—
        env:
          WP_URL: ${{ secrets.WP_URL }}
          WP_USERNAME: ${{ secrets.WP_USERNAME }}
          WP_APP_PASSWORD: ${{ secrets.WP_APP_PASSWORD }}
        run: |
          cat > scripts/backup_wordpress.py << 'EOF'
          import os
          import json
          from datetime import datetime
          from pathlib import Path
          from wordpress_api import WordPressAPI
          
          def backup_posts():
              api = WordPressAPI(
                  os.getenv('WP_URL'),
                  os.getenv('WP_USERNAME'),
                  os.getenv('WP_APP_PASSWORD')
              )
              
              # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
              backup_dir = Path('backups') / datetime.now().strftime('%Y%m%d')
              backup_dir.mkdir(parents=True, exist_ok=True)
              
              # ã™ã¹ã¦ã®æŠ•ç¨¿ã‚’å–å¾—
              page = 1
              all_posts = []
              
              while True:
                  posts = api.get_posts(page=page, per_page=100)
                  if not posts:
                      break
                  all_posts.extend(posts)
                  page += 1
              
              print(f"ğŸ“Š å–å¾—ã—ãŸæŠ•ç¨¿æ•°: {len(all_posts)}")
              
              # æŠ•ç¨¿ã‚’JSONå½¢å¼ã§ä¿å­˜
              for post in all_posts:
                  post_data = {
                      'id': post['id'],
                      'title': post['title']['rendered'],
                      'content': post['content']['rendered'],
                      'status': post['status'],
                      'date': post['date'],
                      'modified': post['modified'],
                      'categories': post['categories'],
                      'tags': post['tags'],
                      'meta': post.get('meta', {})
                  }
                  
                  # ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ
                  safe_title = "".join(c for c in post_data['title'] if c.isalnum() or c in (' ', '-', '_')).rstrip()
                  filename = f"{post_data['id']}_{safe_title[:50]}.json"
                  
                  # ä¿å­˜
                  file_path = backup_dir / filename
                  with open(file_path, 'w', encoding='utf-8') as f:
                      json.dump(post_data, f, ensure_ascii=False, indent=2)
              
              # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚µãƒãƒªãƒ¼ä½œæˆ
              summary = {
                  'backup_date': datetime.now().isoformat(),
                  'total_posts': len(all_posts),
                  'posts_by_status': {
                      'publish': len([p for p in all_posts if p['status'] == 'publish']),
                      'draft': len([p for p in all_posts if p['status'] == 'draft']),
                      'private': len([p for p in all_posts if p['status'] == 'private'])
                  }
              }
              
              with open(backup_dir / 'summary.json', 'w') as f:
                  json.dump(summary, f, indent=2)
              
              return summary
          
          # WordPressAPIã«get_postsãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ 
          def add_get_posts_method():
              from wordpress_api import WordPressAPI
              
              def get_posts(self, page=1, per_page=10, status='any'):
                  url = f"{self.wp_url}/wp-json/wp/v2/posts"
                  params = {
                      'page': page,
                      'per_page': per_page,
                      'status': status
                  }
                  response = requests.get(url, headers=self.headers, params=params)
                  if response.status_code == 200:
                      return response.json()
                  return []
              
              WordPressAPI.get_posts = get_posts
          
          if __name__ == "__main__":
              import requests
              add_get_posts_method()
              summary = backup_posts()
              print(f"âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†: {summary['total_posts']}ä»¶ã®æŠ•ç¨¿ã‚’ä¿å­˜")
          EOF
          
          python scripts/backup_wordpress.py
      
      - name: ğŸ“Š ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ¬ãƒãƒ¼ãƒˆ
        run: |
          echo "## ğŸ’¾ WordPressè¨˜äº‹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          BACKUP_DIR=$(find backups -type d -name "[0-9]*" | sort -r | head -1)
          if [ -f "$BACKUP_DIR/summary.json" ]; then
            cat "$BACKUP_DIR/summary.json" | jq -r '
              "- **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ—¥æ™‚:** " + .backup_date + "\n" +
              "- **ç·è¨˜äº‹æ•°:** " + (.total_posts | tostring) + "\n" +
              "- **å…¬é–‹è¨˜äº‹:** " + (.posts_by_status.publish | tostring) + "\n" +
              "- **ä¸‹æ›¸ã:** " + (.posts_by_status.draft | tostring) + "\n" +
              "- **éå…¬é–‹:** " + (.posts_by_status.private | tostring)
            ' >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ã‚³ãƒŸãƒƒãƒˆ
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add backups/
          git commit -m "ğŸ’¾ WordPressè¨˜äº‹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— - $(date +%Y%m%d)" || echo "å¤‰æ›´ãªã—"
          git push || echo "ãƒ—ãƒƒã‚·ãƒ¥ä¸è¦"
      
      - name: ğŸ§¹ å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å‰Šé™¤
        run: |
          # 30æ—¥ä»¥ä¸Šå‰ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å‰Šé™¤
          find backups -type d -name "[0-9]*" -mtime +30 -exec rm -rf {} + || true
          
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "ğŸ§¹ å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å‰Šé™¤"
            git push
          fi